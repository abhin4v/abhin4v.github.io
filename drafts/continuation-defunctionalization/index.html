<!doctype html>
<html lang="en" class="no-js" prefix="og: http://ogp.me/ns#">
    <head>
        <meta charset="utf-8">
        <meta name="copyright" content="Abhinav Sarkar">
        <meta name="robots" content="index,follow">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="google-site-verification" content="jqi6GjA_kvmDkzCQwNJIPilm810Wwt6P0wsDmiSKmqk">
        
        <meta name="twitter:card" content="summary">
        
        <meta name="twitter:creator" content="@abhin4v">
        <meta name="twitter:title" content="Mechanically Deriving Binary Tree Iterators with Continuation Defunctionalization">

        <meta property="og:url" content="https://abhinavsarkar.net/drafts/continuation-defunctionalization/">
        <meta property="og:type" content="article">
        <meta property="og:title" content="Mechanically Deriving Binary Tree Iterators with Continuation Defunctionalization">
        <meta property="og:locale" content="en_US">
        <meta property="og:site_name" content="abhinavsarkar.net">
        
        <meta name="keywords" content="java, programming, algorithm">
        
        
        <meta name="description" content="Deriving tree iterators from tree traversals using Continuation Defunctionalization.">
        <meta property="og:description" content="Deriving tree iterators from tree traversals using Continuation Defunctionalization.">
        <meta name="twitter:description" content="Deriving tree iterators from tree traversals using Continuation Defunctionalization.">
        
        

        <meta name="language" content="EN">
        <meta name="author" content="Abhinav Sarkar, abhinav@abhinavsarkar.net">
        <meta name="HandheldFriendly" content="True">

        <title>Mechanically Deriving Binary Tree Iterators with Continuation Defunctionalization | abhinavsarkar.net</title>

        <link rel="shortcut icon" type="image/x-icon" href="//abhinavsarkar.net/images/favicon.ico">
        <link rel="archives" title="Archive" href="https://abhinavsarkar.net/archive/">
        <link rel="canonical" href="https://abhinavsarkar.net/drafts/continuation-defunctionalization/">
        
        
        <link rel="me" href="https://abhinavsarkar.net/about/" type="text/html">
        <link rel="me" href="https://twitter.com/abhin4v">
        <link rel="me" href="https://github.com/abhin4v">
        <link rel="pingback" href="https://webmention.io/abhinavsarkar.net/xmlrpc" />
        <link rel="webmention" href="https://webmention.io/abhinavsarkar.net/webmention" />
        <link rel="alternate" type="application/atom+xml" title="abhinavsarkar.net" href="https://abhinavsarkar.net/feed.atom">
        <link rel="alternate" type="application/atom+xml" title="notes.abhinavsarkar.net" href="https://notes.abhinavsarkar.net/feed.atom">

        <script>
        (function() {
          var allowedDomains = ["localhost", "127.0.0.1", "abhinavsarkar.net", "web.archive.org"];
          if (allowedDomains.indexOf(window.location.hostname) == -1) {
            if (window.location.protocol == "http:") {
              location.host = "abhinavsarkar.net:80";
            } else {
              location.host = "abhinavsarkar.net:443";
            }
          }
        })();
        </script>

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css" media="preload" onload="if (media != 'all') media = 'all';">
        <link rel="stylesheet" href="//abhinavsarkar.net/css/article.css" media="preload" onload="if (media != 'all') media = 'all';">
        <noscript>
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css">
          <link rel="stylesheet" href="//abhinavsarkar.net/css/article.css">
        </noscript>

        <!-- Matomo -->
        <script type="text/javascript">
          var _paq = _paq || [];
          _paq.push(['trackPageView']);
          _paq.push(['enableLinkTracking']);
          _paq.push(['trackVisibleContentImpressions']);
          (function() {
            var u="//anna.abhinavsarkar.net/";
            _paq.push(['setTrackerUrl', u+'piwik.php']);
            _paq.push(['setSiteId', '1']);
            var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
            g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
          })();
        </script>
        <!-- End Matomo Code -->
    </head>
    <body class="article-page">
        <noscript>
          <img src="https://anna.abhinavsarkar.net/piwik.php?idsite=1&amp;rec=1" style="border:0; display: none;" alt />
        </noscript>
        <header>
            <nav id="topnav">
                <span class="logo">
                  <a href="//abhinavsarkar.net/">abhinavsarkar.net</a>
                  <label for="menu-toggle" class="label-toggle">
                    <svg height="1em" version="1.1" viewBox="0 0 25 25" width="1em" xmlns="http://www.w3.org/2000/svg" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns" xmlns:xlink="http://www.w3.org/1999/xlink">
                      <g id="hamburger-round">
                        <path d="M0,4 C0,2.8954305 0.889763236,2 2.00359486,2 L22.9964051,2 C24.10296,2 25,2.88772964 25,4 C25,5.1045695 24.1102368,6 22.9964051,6 L2.00359486,6 C0.897039974,6 0,5.11227036 0,4 L0,4 Z M0,12 C0,10.8954305 0.889763236,10 2.00359486,10 L22.9964051,10 C24.10296,10 25,10.8877296 25,12 C25,13.1045695 24.1102368,14 22.9964051,14 L2.00359486,14 C0.897039974,14 0,13.1122704 0,12 L0,12 Z M0,20 C0,18.8954305 0.889763236,18 2.00359486,18 L22.9964051,18 C24.10296,18 25,18.8877296 25,20 C25,21.1045695 24.1102368,22 22.9964051,22 L2.00359486,22 C0.897039974,22 0,21.1122704 0,20 L0,20 Z" id="hamburger"></path>
                      </g>
                    </svg>
                  </label>
                </span>
                <span class="links">
                  <input type="checkbox" id="menu-toggle">
                  <a href="//abhinavsarkar.net/about/">About</a>
<a href="//abhinavsarkar.net/archive/">Posts</a>
<a href="//abhinavsarkar.net/notes/">Notes</a>
<a href="//abhinavsarkar.net/photos/">Photos</a>
<a href="//abhinavsarkar.net/readings/">Readings</a>
<a href="//abhinavsarkar.net/now/">Now</a>
                </span>
            </nav>
        </header>

        <main role="main">
            <article itemscope itemtype="http://schema.org/Article" class="post">
    <header>
        <h1 itemprop="name" id="#top">Mechanically Deriving Binary Tree Iterators with Continuation Defunctionalization</h1>
    </header>

    <ul class="headers">
      <li class="header post-publish-date">
        <svg class="assist-icon" xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 8 8">
          <path d="M6 0l-1 1 2 2 1-1-2-2zm-2 2l-4 4v2h2l4-4-2-2z"></path>
        </svg>
        <span itemprop="datePublished" content="2019-08-17">August 17, 2019</span>
      </li>
      <li class="header post-ert">
        <svg class="assist-icon" xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 8 8">
          <path d="M4 0c-2.2 0-4 1.8-4 4s1.8 4 4 4 4-1.8 4-4-1.8-4-4-4zm0 1c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm-.5 1v2.22l.16.13.5.5.34.38.72-.72-.38-.34-.34-.34v-1.81h-1z"></path>
        </svg>
        A seven minute read
      </li>
      
      <li class="header post-download">
        <svg class="assist-icon" xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 8 8">
          <path d="M3 0v3h-2l3 3 3-3h-2v-3h-2zm-3 7v1h8v-1h-8z"></path>
        </svg>
        <a href="//abhinavsarkar.net/pdfs/posts/continuation-defunctionalization.pdf" download rel="nofollow">Download</a>
      </li>
      <li class="header post-tags">
        
        <svg class="assist-icon tags" xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 8 8">
          <path d="M0 0v2l3 3 1.5-1.5.5-.5-2-2-1-1h-2zm3.41 0l3 3-1.19 1.22.78.78 2-2-3-3h-1.59zm-1.91 1c.28 0 .5.22.5.5s-.22.5-.5.5-.5-.22-.5-.5.22-.5.5-.5z" transform="translate(0 1)"></path>
        </svg> Tags: <a href="//abhinavsarkar.net/tags/programming/">programming</a>
        
      </li>
      <li class="header twitter-button">
        <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-via="abhin4v" data-dnt="true" data-show-count="false">Tweet</a>
      </li>
    </ul>

    <section itemprop="articleBody" class="body">
        <p>Binary tree is the simplest of tree data structures. It is a tree in which each node has at most two children. A tree traversal is a process of visiting each node in the tree, exactly once. There are <a href="https://en.wikipedia.org/wiki/Tree_traversal#Depth-first_search" target="_blank" rel="noopener">multiple ways of traversing</a> a <a href="https://en.wikipedia.org/wiki/binary_tree" target="_blank" rel="noopener">binary tree</a> in depth-first fashion with each traversal resulting in a different enumeration of the tree elements. These tree traversals can be defined as simple recursive functions. But what if we want to write <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/util/Iterator.html" target="_blank" rel="noopener">Java-style iterators</a> for them? And is there a way to mechanically derive these iterators from the simple traversal functions? Let’s find out.</p>
<!-- more -->
<nav id="toc" class="right-toc"><h3>Contents</h3><ol><li><a href="#traversals-and-iterations">Traversals and Iterations</a></li><li><a href="#binary-tree">Binary Tree</a></li><li><a href="#recursive-traversal">Recursive Traversal</a></li><li><a href="#continuations">Continuations</a></li></ol></nav>
<h2 id="traversals-and-iterations" data-track-content data-content-name="traversals-and-iterations" data-content-piece="continuation-defunctionalization">Traversals and Iterations<a href="#traversals-and-iterations" class="ref-link"></a><a href="#top" class="top-link" title="Back to top"></a></h2>
<p>This is a sample binary tree:</p>
<pre class="plain"><code>          D
        /   \
       C      F
      / \    / \
     A   B  E   G</code></pre>
<p>Different traversals of this tree will yield different sequences of elements:</p>
<div class="scrollable-table">
<table>
<thead>
<tr class="header">
<th style="text-align: left;">Traversal</th>
<th style="text-align: left;">Output</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">in-order</td>
<td style="text-align: left;">ACBDEFG</td>
</tr>
<tr class="even">
<td style="text-align: left;">pre-order</td>
<td style="text-align: left;">DCABFEG</td>
</tr>
<tr class="odd">
<td style="text-align: left;">post-order</td>
<td style="text-align: left;">ABCEGFD</td>
</tr>
</tbody>
</table>
</div>
<p>The code for the recursive in-order traversal (traverse left child, then self, then right child) is very simple. Assuming a binary tree is represented with a <code>Tree</code> class like:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">class</span> Tree&lt;T&gt; {</a>
<a class="sourceLine" id="cb2-2" title="2">  Tree&lt;T&gt; left;</a>
<a class="sourceLine" id="cb2-3" title="3">  T content;</a>
<a class="sourceLine" id="cb2-4" title="4">  Tree&lt;T&gt; right;</a>
<a class="sourceLine" id="cb2-5" title="5">}</a></code></pre></div>
<p>this code prints all elements of a tree in in-order:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb3-1" title="1"><span class="dt">static</span> &lt;T&gt; <span class="dt">void</span> <span class="fu">printRecursive</span>(Tree&lt;T&gt; tree) {</a>
<a class="sourceLine" id="cb3-2" title="2">  <span class="kw">if</span> (tree != <span class="kw">null</span>) {</a>
<a class="sourceLine" id="cb3-3" title="3">    <span class="fu">printRecursive</span>(tree.<span class="fu">left</span>);</a>
<a class="sourceLine" id="cb3-4" title="4">    <span class="bu">System</span>.<span class="fu">out</span>.<span class="fu">print</span>(tree.<span class="fu">content</span>);</a>
<a class="sourceLine" id="cb3-5" title="5">    <span class="fu">printRecursive</span>(tree.<span class="fu">right</span>);</a>
<a class="sourceLine" id="cb3-6" title="6">  }</a>
<a class="sourceLine" id="cb3-7" title="7">}</a></code></pre></div>
<p>But the code for an iterator which iterates over a tree in in-order is much more complicated:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">class</span> InOrderIterator&lt;T&gt; <span class="kw">implements</span> <span class="bu">Iterator</span>&lt;T&gt; {</a>
<a class="sourceLine" id="cb4-2" title="2">  <span class="kw">private</span> Tree&lt;T&gt; tree;</a>
<a class="sourceLine" id="cb4-3" title="3">  <span class="kw">private</span> <span class="bu">Stack</span>&lt;Tree&lt;T&gt;&gt; stack = <span class="kw">new</span> <span class="bu">Stack</span>&lt;&gt;();</a>
<a class="sourceLine" id="cb4-4" title="4"></a>
<a class="sourceLine" id="cb4-5" title="5">  <span class="fu">InOrderIterator</span>(Tree&lt;T&gt; tree) { <span class="kw">this</span>.<span class="fu">tree</span> = tree; }</a>
<a class="sourceLine" id="cb4-6" title="6"></a>
<a class="sourceLine" id="cb4-7" title="7">  <span class="at">@Override</span></a>
<a class="sourceLine" id="cb4-8" title="8">  <span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">hasNext</span>() {</a>
<a class="sourceLine" id="cb4-9" title="9">      <span class="kw">return</span> tree != <span class="kw">null</span> || !stack.<span class="fu">isEmpty</span>();</a>
<a class="sourceLine" id="cb4-10" title="10">  }</a>
<a class="sourceLine" id="cb4-11" title="11"></a>
<a class="sourceLine" id="cb4-12" title="12">  <span class="at">@Override</span></a>
<a class="sourceLine" id="cb4-13" title="13">  <span class="kw">public</span> T <span class="fu">next</span>() {</a>
<a class="sourceLine" id="cb4-14" title="14">    <span class="kw">while</span> (<span class="fu">hasNext</span>()) {</a>
<a class="sourceLine" id="cb4-15" title="15">      <span class="kw">if</span> (tree != <span class="kw">null</span>) {</a>
<a class="sourceLine" id="cb4-16" title="16">        stack.<span class="fu">push</span>(tree);</a>
<a class="sourceLine" id="cb4-17" title="17">        tree = tree.<span class="fu">left</span>;</a>
<a class="sourceLine" id="cb4-18" title="18">      } <span class="kw">else</span> {</a>
<a class="sourceLine" id="cb4-19" title="19">        <span class="kw">if</span> (!stack.<span class="fu">isEmpty</span>()) {</a>
<a class="sourceLine" id="cb4-20" title="20">          Tree&lt;T&gt; t = stack.<span class="fu">pop</span>();</a>
<a class="sourceLine" id="cb4-21" title="21">          T content = t.<span class="fu">content</span>;</a>
<a class="sourceLine" id="cb4-22" title="22">          tree = t.<span class="fu">right</span>;</a>
<a class="sourceLine" id="cb4-23" title="23">          <span class="kw">return</span> content;</a>
<a class="sourceLine" id="cb4-24" title="24">        }</a>
<a class="sourceLine" id="cb4-25" title="25">      }</a>
<a class="sourceLine" id="cb4-26" title="26">    }</a>
<a class="sourceLine" id="cb4-27" title="27">    <span class="kw">throw</span> <span class="kw">new</span> <span class="bu">NoSuchElementException</span>();</a>
<a class="sourceLine" id="cb4-28" title="28">  }</a>
<a class="sourceLine" id="cb4-29" title="29">}</a>
<a class="sourceLine" id="cb4-30" title="30"></a>
<a class="sourceLine" id="cb4-31" title="31"><span class="kw">class</span> Main {</a>
<a class="sourceLine" id="cb4-32" title="32">  <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span>(<span class="bu">String</span>[] args) {</a>
<a class="sourceLine" id="cb4-33" title="33">    Tree&lt;<span class="bu">String</span>&gt; tree = <span class="kw">new</span> Tree&lt;&gt;(...);</a>
<a class="sourceLine" id="cb4-34" title="34">    InOrderIterator&lt;<span class="bu">String</span>&gt; inOrderIterator = <span class="kw">new</span> InOrderIterator&lt;&gt;(tree);</a>
<a class="sourceLine" id="cb4-35" title="35">    <span class="kw">while</span> (inOrderIterator.<span class="fu">hasNext</span>()) {</a>
<a class="sourceLine" id="cb4-36" title="36">      <span class="bu">System</span>.<span class="fu">out</span>.<span class="fu">print</span>(inOrderIterator.<span class="fu">next</span>());</a>
<a class="sourceLine" id="cb4-37" title="37">    }</a>
<a class="sourceLine" id="cb4-38" title="38">  }</a>
<a class="sourceLine" id="cb4-39" title="39">}</a></code></pre></div>
<p>The iterator code uses a <code>Stack</code> to simulate the program stack of the recursive traversal. It takes some thinking about the tree structure and the program flow to write this code and it is easy to get it wrong<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>. <a href="https://web.archive.org/web/20181208215122/https://www.geeksforgeeks.org/iterative-preorder-traversal/" target="_blank" rel="noopener">Pre-order</a> and <a href="https://web.archive.org/web/20181208215122/https://www.geeksforgeeks.org/iterative-postorder-traversal-using-stack/" target="_blank" rel="noopener">Post-order</a> iterators are even more complicated. Is there a way to mechanically derive the iterators starting from the recursive traversals by following some rules? Indeed there is! Keep reading for details.</p>
<h2 id="binary-tree" data-track-content data-content-name="binary-tree" data-content-piece="continuation-defunctionalization">Binary Tree<a href="#binary-tree" class="ref-link"></a><a href="#top" class="top-link" title="Back to top"></a></h2>
<p>Let’s start with some setup code:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">import</span><span class="im"> java.util.Iterator;</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="kw">import</span><span class="im"> java.util.NoSuchElementException;</span></a>
<a class="sourceLine" id="cb5-3" title="3"><span class="kw">import</span><span class="im"> java.util.Stack;</span></a>
<a class="sourceLine" id="cb5-4" title="4"><span class="kw">import</span><span class="im"> java.util.concurrent.ThreadLocalRandom;</span></a>
<a class="sourceLine" id="cb5-5" title="5"><span class="kw">import</span><span class="im"> java.util.function.Consumer;</span></a>
<a class="sourceLine" id="cb5-6" title="6"><span class="kw">import</span><span class="im"> java.util.function.Supplier;</span></a>
<a class="sourceLine" id="cb5-7" title="7"></a>
<a class="sourceLine" id="cb5-8" title="8"><span class="kw">class</span> Utils {</a>
<a class="sourceLine" id="cb5-9" title="9">  <span class="dt">static</span> &lt;T&gt; <span class="dt">void</span> <span class="fu">printContent</span>(T t) {</a>
<a class="sourceLine" id="cb5-10" title="10">    <span class="bu">System</span>.<span class="fu">out.printf</span>(t + <span class="st">&quot; &quot;</span>);</a>
<a class="sourceLine" id="cb5-11" title="11">  }</a>
<a class="sourceLine" id="cb5-12" title="12"></a>
<a class="sourceLine" id="cb5-13" title="13">  <span class="dt">static</span> <span class="bu">String</span> <span class="fu">generateRandomAlphaString</span>(<span class="dt">int</span> maxLength) {</a>
<a class="sourceLine" id="cb5-14" title="14">    ThreadLocalRandom random = ThreadLocalRandom.<span class="fu">current</span>();</a>
<a class="sourceLine" id="cb5-15" title="15">    <span class="dt">int</span> targetLength = random.<span class="fu">nextInt</span>(maxLength) + <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb5-16" title="16">    <span class="bu">StringBuilder</span> sb = <span class="kw">new</span> <span class="bu">StringBuilder</span>(targetLength);</a>
<a class="sourceLine" id="cb5-17" title="17">    <span class="kw">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; targetLength; i++) {</a>
<a class="sourceLine" id="cb5-18" title="18">      sb.<span class="fu">append</span>((<span class="dt">char</span>) random.<span class="fu">nextInt</span>(<span class="ch">'a'</span>, <span class="ch">'z'</span> + <span class="dv">1</span>));</a>
<a class="sourceLine" id="cb5-19" title="19">    }</a>
<a class="sourceLine" id="cb5-20" title="20">    <span class="kw">return</span> sb.<span class="fu">toString</span>();</a>
<a class="sourceLine" id="cb5-21" title="21">  }</a>
<a class="sourceLine" id="cb5-22" title="22"></a>
<a class="sourceLine" id="cb5-23" title="23">  <span class="dt">static</span> <span class="bu">StringBuilder</span> <span class="fu">makeGuidelines</span>(<span class="dt">int</span> times) {</a>
<a class="sourceLine" id="cb5-24" title="24">    <span class="bu">StringBuilder</span> sb = <span class="kw">new</span> <span class="bu">StringBuilder</span>();</a>
<a class="sourceLine" id="cb5-25" title="25">    <span class="kw">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; times; i++) {</a>
<a class="sourceLine" id="cb5-26" title="26">      sb.<span class="fu">append</span>('│');</a>
<a class="sourceLine" id="cb5-27" title="27">    }</a>
<a class="sourceLine" id="cb5-28" title="28">    <span class="kw">return</span> sb.<span class="fu">append</span>(<span class="st">&quot;├ &quot;</span>);</a>
<a class="sourceLine" id="cb5-29" title="29">  }</a>
<a class="sourceLine" id="cb5-30" title="30">}</a></code></pre></div>
<p>With these imports and utility functions out of our way, let’s first define a Binary Tree:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">class</span> Tree&lt;T&gt; {</a>
<a class="sourceLine" id="cb6-2" title="2">  Tree&lt;T&gt; left;</a>
<a class="sourceLine" id="cb6-3" title="3">  T content;</a>
<a class="sourceLine" id="cb6-4" title="4">  Tree&lt;T&gt; right;</a>
<a class="sourceLine" id="cb6-5" title="5"></a>
<a class="sourceLine" id="cb6-6" title="6">  <span class="fu">Tree</span>(Tree&lt;T&gt; left, T content, Tree&lt;T&gt; right) {</a>
<a class="sourceLine" id="cb6-7" title="7">    <span class="kw">this</span>.<span class="fu">left</span> = left;</a>
<a class="sourceLine" id="cb6-8" title="8">    <span class="kw">this</span>.<span class="fu">content</span> = content;</a>
<a class="sourceLine" id="cb6-9" title="9">    <span class="kw">this</span>.<span class="fu">right</span> = right;</a>
<a class="sourceLine" id="cb6-10" title="10">  }</a>
<a class="sourceLine" id="cb6-11" title="11"></a>
<a class="sourceLine" id="cb6-12" title="12">  <span class="kw">public</span> <span class="dt">static</span> &lt;T&gt; Tree&lt;T&gt; <span class="fu">generate</span>(</a>
<a class="sourceLine" id="cb6-13" title="13">      <span class="dt">int</span> maxDepth, Supplier&lt;T&gt; gen, <span class="dt">double</span> nullProbability) {</a>
<a class="sourceLine" id="cb6-14" title="14">    <span class="kw">if</span> (nullProbability &lt; <span class="dv">0</span> || nullProbability &gt; <span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb6-15" title="15">      <span class="kw">throw</span> <span class="kw">new</span> <span class="bu">IllegalArgumentException</span>(<span class="st">&quot;nullProbability must be between 0 and 1&quot;</span>);</a>
<a class="sourceLine" id="cb6-16" title="16">    }</a>
<a class="sourceLine" id="cb6-17" title="17"></a>
<a class="sourceLine" id="cb6-18" title="18">    <span class="kw">if</span> (maxDepth == <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb6-19" title="19">      <span class="kw">return</span> <span class="kw">null</span>;</a>
<a class="sourceLine" id="cb6-20" title="20">    }</a>
<a class="sourceLine" id="cb6-21" title="21"></a>
<a class="sourceLine" id="cb6-22" title="22">    <span class="dt">double</span> rand = ThreadLocalRandom.<span class="fu">current</span>().<span class="fu">nextDouble</span>();</a>
<a class="sourceLine" id="cb6-23" title="23">    <span class="kw">if</span> (rand &lt; nullProbability) {</a>
<a class="sourceLine" id="cb6-24" title="24">      <span class="kw">return</span> <span class="kw">null</span>;</a>
<a class="sourceLine" id="cb6-25" title="25">    }</a>
<a class="sourceLine" id="cb6-26" title="26"></a>
<a class="sourceLine" id="cb6-27" title="27">    Tree&lt;T&gt; left = <span class="fu">generate</span>(maxDepth - <span class="dv">1</span>, gen, nullProbability);</a>
<a class="sourceLine" id="cb6-28" title="28">    Tree&lt;T&gt; right = <span class="fu">generate</span>(maxDepth - <span class="dv">1</span>, gen, nullProbability);</a>
<a class="sourceLine" id="cb6-29" title="29">    <span class="kw">return</span> <span class="kw">new</span> Tree&lt;&gt;(left, gen.<span class="fu">get</span>(), right);</a>
<a class="sourceLine" id="cb6-30" title="30">  }</a>
<a class="sourceLine" id="cb6-31" title="31"></a>
<a class="sourceLine" id="cb6-32" title="32">  <span class="at">@Override</span></a>
<a class="sourceLine" id="cb6-33" title="33">  <span class="kw">public</span> <span class="bu">String</span> <span class="fu">toString</span>() {</a>
<a class="sourceLine" id="cb6-34" title="34">    <span class="kw">return</span> <span class="fu">toStringLayout</span>(<span class="dv">0</span>).<span class="fu">toString</span>();</a>
<a class="sourceLine" id="cb6-35" title="35">  }</a>
<a class="sourceLine" id="cb6-36" title="36"></a>
<a class="sourceLine" id="cb6-37" title="37">  <span class="kw">private</span> <span class="bu">StringBuilder</span> <span class="fu">toStringLayout</span>(<span class="dt">int</span> level) {</a>
<a class="sourceLine" id="cb6-38" title="38">    <span class="bu">StringBuilder</span> guidelines = Utils.<span class="fu">makeGuidelines</span>(level);</a>
<a class="sourceLine" id="cb6-39" title="39">    <span class="bu">StringBuilder</span> sb = </a>
<a class="sourceLine" id="cb6-40" title="40">      <span class="kw">new</span> <span class="bu">StringBuilder</span>().<span class="fu">append</span>(guidelines).<span class="fu">append</span>(content).<span class="fu">append</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb6-41" title="41">    <span class="kw">if</span> (<span class="kw">this</span>.<span class="fu">left</span> == <span class="kw">null</span> &amp;&amp; <span class="kw">this</span>.<span class="fu">right</span> == <span class="kw">null</span>) {</a>
<a class="sourceLine" id="cb6-42" title="42">      <span class="kw">return</span> sb;</a>
<a class="sourceLine" id="cb6-43" title="43">    }</a>
<a class="sourceLine" id="cb6-44" title="44"></a>
<a class="sourceLine" id="cb6-45" title="45">    <span class="kw">if</span> (<span class="kw">this</span>.<span class="fu">left</span> != <span class="kw">null</span>) {</a>
<a class="sourceLine" id="cb6-46" title="46">      sb.<span class="fu">append</span>(<span class="kw">this</span>.<span class="fu">left</span>.<span class="fu">toStringLayout</span>(level + <span class="dv">1</span>));</a>
<a class="sourceLine" id="cb6-47" title="47">    } <span class="kw">else</span> {</a>
<a class="sourceLine" id="cb6-48" title="48">      sb.<span class="fu">append</span>(guidelines).<span class="fu">append</span>(<span class="st">&quot;&lt;NULL&gt;</span><span class="sc">\n</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb6-49" title="49">    }</a>
<a class="sourceLine" id="cb6-50" title="50"></a>
<a class="sourceLine" id="cb6-51" title="51">    <span class="kw">if</span> (<span class="kw">this</span>.<span class="fu">right</span> != <span class="kw">null</span>) {</a>
<a class="sourceLine" id="cb6-52" title="52">      sb.<span class="fu">append</span>(<span class="kw">this</span>.<span class="fu">right</span>.<span class="fu">toStringLayout</span>(level + <span class="dv">1</span>));</a>
<a class="sourceLine" id="cb6-53" title="53">    } <span class="kw">else</span> {</a>
<a class="sourceLine" id="cb6-54" title="54">      sb.<span class="fu">append</span>(guidelines).<span class="fu">append</span>(<span class="st">&quot;&lt;NULL&gt;</span><span class="sc">\n</span><span class="st">&quot;</span>);</a>
<a class="sourceLine" id="cb6-55" title="55">    }</a>
<a class="sourceLine" id="cb6-56" title="56"></a>
<a class="sourceLine" id="cb6-57" title="57">    <span class="kw">return</span> sb;</a>
<a class="sourceLine" id="cb6-58" title="58">  }</a>
<a class="sourceLine" id="cb6-59" title="59">}</a></code></pre></div>
<p>Each node in a binary tree has some content and two nullable child nodes. We have a constructor to create the tree. The <code>generate</code> function generates an arbitrary binary tree of a given maximum depth by using a random content generator. We will used this function to generate trees to test our traversals and iterators.</p>
<p>We also implement the <code>toString</code> method for the tree to create a string representation of the tree to help us in debugging. A sample run:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb7-1" title="1">Tree&lt;<span class="bu">String</span>&gt; tree = Tree.<span class="fu">generate</span>(<span class="dv">4</span>, () -&gt; Utils.<span class="fu">generateRandomAlphaString</span>(<span class="dv">2</span>), <span class="fl">0.</span><span class="dv">1</span>);</a>
<a class="sourceLine" id="cb7-2" title="2"><span class="bu">System</span>.<span class="fu">out</span>.<span class="fu">println</span>(tree);</a></code></pre></div>
<p>Output:</p>
<pre class="plain low-line-height"><code>├ r
│├ j
││├ x
│││├ e
│││├ m
││├ vz
│││├ g
││├ &lt;NULL&gt;
│├ l
││├ b
│││├ qc
│││├ g
││├ rp
│││├ d
│││├ o</code></pre>
<h2 id="recursive-traversal" data-track-content data-content-name="recursive-traversal" data-content-piece="continuation-defunctionalization">Recursive Traversal<a href="#recursive-traversal" class="ref-link"></a><a href="#top" class="top-link" title="Back to top"></a></h2>
<p>Credits first: this blog post and the code in it is inspired by <a href="http://www.pathsensitive.com/2019/07/the-best-refactoring-youve-never-heard.html" target="_blank" rel="noopener">The Best Refactoring You’ve Never Heard Of</a> article (and talk) by James Koppel. In the talk, James shows how to transform a recursive in-order traversal into an iterative one. For this post, I’ve chosen to implement pre-order and post-order iterators.</p>
<p>Let’s start with the recursive pre-order traversal which prints the content of every node in the tree in pre-order — each node’s content is printed before its children’s.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb9-1" title="1"><span class="dt">static</span> &lt;T&gt; <span class="dt">void</span> <span class="fu">printRecursive</span>(Tree&lt;T&gt; tree) {</a>
<a class="sourceLine" id="cb9-2" title="2">  <span class="kw">if</span> (tree != <span class="kw">null</span>) {</a>
<a class="sourceLine" id="cb9-3" title="3">    Utils.<span class="fu">printContent</span>(tree.<span class="fu">content</span>);</a>
<a class="sourceLine" id="cb9-4" title="4">    <span class="fu">printRecursive</span>(tree.<span class="fu">left</span>);</a>
<a class="sourceLine" id="cb9-5" title="5">    <span class="fu">printRecursive</span>(tree.<span class="fu">right</span>);</a>
<a class="sourceLine" id="cb9-6" title="6">  }</a>
<a class="sourceLine" id="cb9-7" title="7">}</a>
<a class="sourceLine" id="cb9-8" title="8"></a>
<a class="sourceLine" id="cb9-9" title="9"><span class="fu">printRecursive</span>(tree);</a>
<a class="sourceLine" id="cb9-10" title="10"><span class="co">// r j x e m vz g l b qc g rp d o</span></a></code></pre></div>
<p>Short and sweet, simple and easy to understand. If the tree is not null, we print its content, then we recursively print the left and right child trees.</p>
<p>First thing to do is to extract out the print action into a function argument so that we can do different kinds of actions on the nodes instead of just printing them:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb10-1" title="1"><span class="dt">static</span> &lt;T&gt; <span class="dt">void</span> <span class="fu">iterateRecursive</span>(Tree&lt;T&gt; tree, Consumer&lt;T&gt; action) {</a>
<a class="sourceLine" id="cb10-2" title="2">  <span class="kw">if</span> (tree != <span class="kw">null</span>) {</a>
<a class="sourceLine" id="cb10-3" title="3">    action.<span class="fu">accept</span>(tree.<span class="fu">content</span>);</a>
<a class="sourceLine" id="cb10-4" title="4">    <span class="fu">iterateRecursive</span>(tree.<span class="fu">left</span>, action);</a>
<a class="sourceLine" id="cb10-5" title="5">    <span class="fu">iterateRecursive</span>(tree.<span class="fu">right</span>, action);</a>
<a class="sourceLine" id="cb10-6" title="6">  }</a>
<a class="sourceLine" id="cb10-7" title="7">}</a></code></pre></div>
<p>We use <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/util/function/Consumer.html" target="_blank" rel="noopener"><code>Consumer</code></a> for the type of the action. Since <code>Consumer</code> is a functional interface, we can pass lambdas in its place. We can call it like this:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb11-1" title="1"><span class="fu">iterateRecursive</span>(tree, Utils::printContent);</a>
<a class="sourceLine" id="cb11-2" title="2"><span class="co">// r j x e m vz g l b qc g rp d o</span></a></code></pre></div>
<p>This transformation was easy to grok. The next one requires a little head-tilting. We convert the simple recursion into a <em>Continuation-passing style</em> (CPS) recursion:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb12-1" title="1"><span class="dt">static</span> &lt;T&gt; <span class="dt">void</span> <span class="fu">iterateCPS</span>(Tree&lt;T&gt; tree, Consumer&lt;T&gt; action, <span class="bu">Runnable</span> cont) {</a>
<a class="sourceLine" id="cb12-2" title="2">  <span class="kw">if</span> (tree != <span class="kw">null</span>) {</a>
<a class="sourceLine" id="cb12-3" title="3">    action.<span class="fu">accept</span>(tree.<span class="fu">content</span>);</a>
<a class="sourceLine" id="cb12-4" title="4">    <span class="fu">iterateCPS</span>(tree.<span class="fu">left</span>, action, () -&gt; <span class="fu">iterateCPS</span>(tree.<span class="fu">right</span>, action, cont));</a>
<a class="sourceLine" id="cb12-5" title="5">  } <span class="kw">else</span> {</a>
<a class="sourceLine" id="cb12-6" title="6">    cont.<span class="fu">run</span>();</a>
<a class="sourceLine" id="cb12-7" title="7">  }</a>
<a class="sourceLine" id="cb12-8" title="8">}</a></code></pre></div>
<p>So what is <em>Continuation-passing style</em>?</p>
<h2 id="continuations" data-track-content data-content-name="continuations" data-content-piece="continuation-defunctionalization">Continuations<a href="#continuations" class="ref-link"></a><a href="#top" class="top-link" title="Back to top"></a></h2>
<p>In the usual direct <a href="https://en.wikipedia.org/wiki/imperative_programming" target="_blank" rel="noopener">imperative programming</a> style, we write one statement after another, as a sequence of steps to execute. There is another way of thinking about it: after returning from executing one statement, the rest of the program — which can be thought of as a big statement itself — is run. In <em>Continuation-passing style</em>, this way is made explicit: each statement takes the rest of the program which comes after it as an argument, which it invokes explicitly. For example, if you have a program written in direct style like this:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb13-1" title="1"><span class="dt">static</span> <span class="dt">int</span> <span class="fu">start</span>(<span class="bu">String</span> s) {</a>
<a class="sourceLine" id="cb13-2" title="2">  <span class="dt">int</span> a = <span class="fu">getSomething</span>(s);</a>
<a class="sourceLine" id="cb13-3" title="3">  <span class="fu">doAnotherThing</span>(a);</a>
<a class="sourceLine" id="cb13-4" title="4">  <span class="kw">return</span> a;</a>
<a class="sourceLine" id="cb13-5" title="5">}</a></code></pre></div>
<p>It can be converted into an equivalent CPS style program like this:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb14-1" title="1"><span class="dt">static</span> <span class="dt">void</span> <span class="fu">startCPS</span>(<span class="bu">String</span> s, <span class="bu">Callable</span>&lt;<span class="bu">Integer</span>&gt; cont) {</a>
<a class="sourceLine" id="cb14-2" title="2">  <span class="fu">getSomethingCPS</span>(s, (a) -&gt; {</a>
<a class="sourceLine" id="cb14-3" title="3">    <span class="fu">doAnotherThingCPS</span>(a, () -&gt; {</a>
<a class="sourceLine" id="cb14-4" title="4">      cont.<span class="fu">call</span>(a);</a>
<a class="sourceLine" id="cb14-5" title="5">    });</a>
<a class="sourceLine" id="cb14-6" title="6">  });</a>
<a class="sourceLine" id="cb14-7" title="7">}</a>
<a class="sourceLine" id="cb14-8" title="8"></a>
<a class="sourceLine" id="cb14-9" title="9"><span class="dt">static</span> <span class="dt">void</span> <span class="fu">getSomethingCPS</span>(<span class="bu">String</span> s, <span class="bu">Callable</span>&lt;<span class="bu">Integer</span>&gt; cont) {</a>
<a class="sourceLine" id="cb14-10" title="10">  cont.<span class="fu">call</span>(<span class="fu">getSomething</span>(s));</a>
<a class="sourceLine" id="cb14-11" title="11">}</a>
<a class="sourceLine" id="cb14-12" title="12"></a>
<a class="sourceLine" id="cb14-13" title="13"><span class="dt">static</span> <span class="dt">void</span> <span class="fu">doAnotherThingCPS</span>(<span class="dt">int</span> a, <span class="bu">Runnable</span> cont) {</a>
<a class="sourceLine" id="cb14-14" title="14">  <span class="fu">doAnotherThing</span>(a);</a>
<a class="sourceLine" id="cb14-15" title="15">  cont.<span class="fu">run</span>();</a>
<a class="sourceLine" id="cb14-16" title="16">}</a></code></pre></div>
<p>We see how each function call takes the rest of the program after it as a lambda and calls it explicitly to further the flow of the program. Instead of returning an <code>int</code> value, the <code>startCPS</code> function now takes a lambda as an additional argument which it calls with the <code>int</code> value at the end of all the processing. These lambdas are known as <em>Continuations</em> because they <strong>continue</strong> the flow of the programs, and hence this style of writing programs is called the <em><a href="https://en.wikipedia.org/wiki/Continuation-passing_style" target="_blank" rel="noopener">Continuation-passing style</a></em>.</p>
<section class="footnotes">
<hr />
<ol>
<li id="fn1"><p>These traversals can be generalized to take a function which they call with the content of each node. Such traversals are examples of <a href="https://en.wikipedia.org/wiki/Iterator#Internal_Iterators" target="_blank" rel="noopener">Internal Iterators</a>. <a href="https://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/util/Iterator.html" target="_blank" rel="noopener">Java-style iterators</a> on the other hand are examples of <a href="https://en.wikipedia.org/wiki/Iterator#External_iterators_and_the_iterator_pattern" target="_blank" rel="noopener">External Iterators</a>.<a href="#fnref1" class="footnote-back">↩</a></p></li>
</ol>
</section>
    </section>
    <section class="source">
        
          Posted by <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Abhinav Sarkar</span></span>
        
      <a href="https://github.com/abhin4v/abhin4v.github.io/commits/source/posts/continuation-defunctionalization.md" target="_blank" rel="noopener" style="float: right;">
        Post history
      </a>
    </section>
</article>
<meta itemprop="url" content="https://abhinavsarkar.net/drafts/continuation-defunctionalization/">

<div class="subscription-msg">
  <h3>Like this post? Subscribe below to get future posts by email.</h3>
<form id="subscription" action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open('https://feedburner.google.com/fb/a/mailverify?uri=abhinavsarkarnet', 'popupwindow', 'scrollbars=yes,width=550,height=520');return true">
  <input type="email" name="email" required placeholder="your.email@example.com" />
  <input type="hidden" value="abhinavsarkarnet" name="uri" />
  <input type="hidden" name="loc" value="en_US" />
  <input type="submit" value="Subscribe" />
</form>

</div>





<ul class="pager">
  <li class="previous">
    
    <a href="//abhinavsarkar.net/drafts/solving-aoc3-with-haskell-interval-trees/" title="Previous">
      <svg class="assist-icon" xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 8 8">
        <path d="M4 0l-4 4 4 4 1.5-1.5-2.5-2.5 2.5-2.5-1.5-1.5z" transform="translate(1)"></path>
      </svg>
      <span class="ind">Previous</span> <br>
      <span class="title">No Matter How You Slice It with Haskell and Interval Trees</span>
    </a>
    
  </li>

  <li class="next">
    
  </li>
</ul>

<script src="//abhinavsarkar.net/js/post-styling.js" defer async></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/haskell.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.1.0/highlightjs-line-numbers.min.js"></script>
<script src="https://platform.twitter.com/widgets.js" charset="utf-8" defer async></script>
<script>
  hljs.initHighlightingOnLoad();
  hljs.initLineNumbersOnLoad({
    singleLine: true
  });

  window.setTimeout(function() {
      if (window.twttr == undefined) {
        document.getElementsByClassName("twitter-button")[0].setAttribute("style", "display: none");
      }
    }, 3000);
</script>


        </main>

        <footer>
          <nav id="bottomnav">
            <span class="links">
                <a href="//abhinavsarkar.net/">Home</a>
                <a href="//abhinavsarkar.net/about/">About</a>
<a href="//abhinavsarkar.net/archive/">Posts</a>
<a href="//abhinavsarkar.net/notes/">Notes</a>
<a href="//abhinavsarkar.net/photos/">Photos</a>
<a href="//abhinavsarkar.net/readings/">Readings</a>
<a href="//abhinavsarkar.net/now/">Now</a>
            </span>
          </nav>
          <div id="copy">
            <span style="float: left">© 2017-2019, Abhinav Sarkar</span>
            Generated by <a href="http://jaspervdj.be/hakyll" target="_blank" rel="noopener">Hakyll</a>
            <span id="gen-time" class="hide-small"></span> |
            <a href="https://github.com/abhin4v/abhin4v.github.io" target="_blank" rel="noopener">Source</a>
          </div>
        </footer>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
      document.documentElement.className = document.documentElement.className.replace("no-js","js");

      jQuery("nav .links a").each(function() {
        if (new URL(this.href).pathname === window.location.pathname) {
          jQuery(this).css('font-weight', 'bold');
        }
      });

      function loadStyleSheet(src) {
        if (document.createStyleSheet){
          document.createStyleSheet(src);
        } else {
          jQuery("head").append(jQuery("<link rel='stylesheet' href='"+src+"' type='text/css'>"));
        }
      }

      jQuery(window).ready(function setGenTime() {
        if (window.performance && window.performance.timing) {
          var t = window.performance.timing;
          var elapsed = t.loadEventEnd - t.navigationStart;
          if (elapsed >= 0) {
            jQuery("#gen-time").text("| Served in " + elapsed + " ms");
          } else {
            window.setTimeout(setGenTime, 1000);
          }
        }
      });
    </script>
    <style type="text/css" media="print">
      @page {
        size: A4;
        margin: 12mm 17mm 12mm 17mm;
      }
    </style>
  </body>
</html>
