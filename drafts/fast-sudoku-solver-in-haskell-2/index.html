<!doctype html>
<html lang="en" class="no-js" prefix="og: http://ogp.me/ns#">
    <head>
        <meta charset="utf-8">
        <meta name="copyright" content="Abhinav Sarkar">
        <meta name="robots" content="index,follow">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="google-site-verification" content="jqi6GjA_kvmDkzCQwNJIPilm810Wwt6P0wsDmiSKmqk">
        <meta name="twitter:card" content="summary">
        <meta name="twitter:creator" content="@abhin4v">

        <meta property="og:url" content="https://abhinavsarkar.net/drafts/fast-sudoku-solver-in-haskell-2/">
        <meta property="og:type" content="article">
        <meta property="og:title" content="Fast Sudoku Solver in Haskell #2: 500x Faster!">
        <meta property="og:locale" content="en_US">
        <meta property="og:site_name" content="abhinavsarkar.net">
        
        <meta name="keywords" content="haskell, sudoku, programming, puzzle">
        
        
        <meta name="description" content="We write a Sudoku Solver in Haskell and optimize it to be fast">
        <meta property="og:description" content="We write a Sudoku Solver in Haskell and optimize it to be fast">
        
        <meta name="language" content="EN">
        <meta name="author" content="Abhinav Sarkar, abhinav@abhinavsarkar.net">
        <meta name="HandheldFriendly" content="True">

        <title>Fast Sudoku Solver in Haskell #2: 500x Faster! | abhinavsarkar.net</title>

        <link rel="shortcut icon" type="image/x-icon" href="../../images/favicon.ico">
        <link rel="archives" title="Archive" href="https://abhinavsarkar.net/archive/">
        <link rel="canonical" href="https://abhinavsarkar.net/drafts/fast-sudoku-solver-in-haskell-2/">
        <link rel="me" href="https://abhinavsarkar.net/about/" type="text/html">
        <link rel="alternate" type="application/atom+xml" title="abhinavsarkar.net" href="https://abhinavsarkar.net/feed.xml">

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css">
        <link rel="stylesheet" href="../../css/default.css">
        <link rel="stylesheet" href="../../css/syntax.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono|Lato|Noto+Serif|Cardo">

        <!-- Global Site Tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-109237-6"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments)};
          gtag('js', new Date());

          gtag('config', 'UA-109237-6');
        </script>
    </head>
    <body>
        <header>
            <nav id="topnav">
                <span class="logo">
                  <a href="../../">abhinavsarkar.net</a>
                  <label for="menu-toggle" class="label-toggle">
                    <svg height="1em" version="1.1" viewBox="0 0 25 25" width="1em" xmlns="http://www.w3.org/2000/svg" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns" xmlns:xlink="http://www.w3.org/1999/xlink">
                      <g id="hamburger-round">
                        <path d="M0,4 C0,2.8954305 0.889763236,2 2.00359486,2 L22.9964051,2 C24.10296,2 25,2.88772964 25,4 C25,5.1045695 24.1102368,6 22.9964051,6 L2.00359486,6 C0.897039974,6 0,5.11227036 0,4 L0,4 Z M0,12 C0,10.8954305 0.889763236,10 2.00359486,10 L22.9964051,10 C24.10296,10 25,10.8877296 25,12 C25,13.1045695 24.1102368,14 22.9964051,14 L2.00359486,14 C0.897039974,14 0,13.1122704 0,12 L0,12 Z M0,20 C0,18.8954305 0.889763236,18 2.00359486,18 L22.9964051,18 C24.10296,18 25,18.8877296 25,20 C25,21.1045695 24.1102368,22 22.9964051,22 L2.00359486,22 C0.897039974,22 0,21.1122704 0,20 L0,20 Z" id="hamburger"></path>
                      </g>
                    </svg>
                  </label>
                </span>
                <span class="links">
                  <input type="checkbox" id="menu-toggle">
                  <a href="../../about/">About Me</a>
                  <a href="../../archive/">Archive</a>
                  <a href="../../activities/" class="hide-small">Activities</a>
                  <a href="../../readings/" class="hide-small">Readings</a>
                </span>
            </nav>
        </header>

        <main role="main">
            <article itemscope itemtype="http://schema.org/Article" class="post">
    <header>
        <h1 itemprop="name" id="#top">Fast Sudoku Solver in Haskell #2: 500x Faster!</h1>
    </header>
    <section class="header">
        <span class="fa fa-pencil fa-fw" aria-hidden="true"></span>
        Posted on <span itemprop="datePublished" content="2018-06-28">June 28, 2018</span>
        
            by <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Abhinav Sarkar</span></span>
        
    </section>
    <section class="header">
        
        <span class="fa fa-tags fa-fw" aria-hidden="true"></span> Tags: <a href="../../tags/haskell/">haskell</a>, <a href="../../tags/sudoku/">sudoku</a>, <a href="../../tags/programming/">programming</a>, <a href="../../tags/puzzle/">puzzle</a>
        
    </section>
    <section class="header post-download">
        <span class="fa fa-download fa-fw" aria-hidden="true"></span> Download as
        <a href="../../pdfs/posts/fast-sudoku-solver-in-haskell-2.pdf" download rel="nofollow">PDF</a> or
        <a href="../../drafts/fast-sudoku-solver-in-haskell-2.md" download rel="nofollow">Markdown</a>
    </section>
    <section class="header twitter-button">
      <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-size="large" data-via="abhin4v" data-dnt="true" data-show-count="false">Tweet</a>
    </section>
    <section itemprop="articleBody" class="body">
        <div class="ert">
6 minute read
</div>
<p>In the <a href="../../posts/fast-sudoku-solver-in-haskell-1/">first part</a> of this series of posts, we wrote a simple <a href="https://en.wikipedia.org/wiki/Sudoku" target="_blank" rel="noopener">Sudoku</a> solver in <a href="https://www.haskell.org/" target="_blank" rel="noopener">Haskell</a> which used a <a href="https://en.wikipedia.org/wiki/Constraint_satisfaction_problem" target="_blank" rel="noopener">constraint satisfaction</a> algorithm with <a href="https://en.wikipedia.org/wiki/Depth-first_search" target="_blank" rel="noopener">backtracking</a>. The solution worked well but was found to be very slow. In this post, we are going to improve the solution to make it <strong>fast</strong>.</p>
<!--more-->
<nav id="toc" class="right-toc"><h3>Contents</h3><ol><li><a href="#quick-recap">Quick Recap</a></li><li><a href="#constraints-and-corollaries">Constraints and Corollaries</a></li><li><a href="#singles-twins-and-triplets">Singles, Twins and Triplets</a></li></ol></nav>
<h2 id="quick-recap">Quick Recap<a href="#quick-recap" class="ref-link"></a><a href="#top" class="top-link" title="Back to top"></a></h2>
<p><a href="https://en.wikipedia.org/wiki/Sudoku" target="_blank" rel="noopener">Sudoku</a> is a number placement puzzle. It consists of a 9x9 grid which is to be filled with digits from 1 to 9 such that each row, each column and each of the nine 3x3 sub-grids contain all of the digits. Some of the cells of the grid come pre-filled and the player has to fill the rest.</p>
<p>In the <a href="../../posts/fast-sudoku-solver-in-haskell-1/">previous post</a>, we implemented a simple Sudoku solver without paying much attention to its performance characteristics. We ran some of <a href="../../files/sudoku17.txt.bz2">17-clue puzzles</a> through our program to see how fast it was:</p>
<pre class="plain"><code>$ head -n100 sudoku17.txt | time stack exec sudoku
... output omitted ...
      116.70 real       198.09 user        94.46 sys</code></pre>
<p>So, it took about 117 seconds to solve one hundred puzzles. At this speed, it would take about 16 hours to solve all the 49151 puzzles contained in the file. This is just too slow. We need to find ways to make it faster. Let’s go back to the drawing board.</p>
<h2 id="constraints-and-corollaries">Constraints and Corollaries<a href="#constraints-and-corollaries" class="ref-link"></a><a href="#top" class="top-link" title="Back to top"></a></h2>
<p>In a Sudoku puzzle, we are given a partially filled 9x9 grid and we have to fill the rest of the grid such that each of the nine rows, columns and sub-grids (called “blocks” in general) have all of the digits, from 1 to 9.</p>
<pre class="plain low-line-height"><code>+-------+-------+-------+
| . . . | . . . | . 1 . |
| 4 . . | . . . | . . . |
| . 2 . | . . . | . . . |
+-------+-------+-------+
| . . . | . 5 . | 4 . 7 |
| . . 8 | . . . | 3 . . |
| . . 1 | . 9 . | . . . |
+-------+-------+-------+
| 3 . . | 4 . . | 2 . . |
| . 5 . | 1 . . | . . . |
| . . . | 8 . 6 | . . . |
+-------+-------+-------+
    A sample puzzle

+-------+-------+-------+
| 6 9 3 | 7 8 4 | 5 1 2 |
| 4 8 7 | 5 1 2 | 9 3 6 |
| 1 2 5 | 9 6 3 | 8 7 4 |
+-------+-------+-------+
| 9 3 2 | 6 5 1 | 4 8 7 |
| 5 6 8 | 2 4 7 | 3 9 1 |
| 7 4 1 | 3 9 8 | 6 2 5 |
+-------+-------+-------+
| 3 1 9 | 4 7 5 | 2 6 8 |
| 8 5 6 | 1 2 9 | 7 4 3 |
| 2 7 4 | 8 3 6 | 1 5 9 |
+-------+-------+-------+
    and its solution</code></pre>
<p>Previously, we followed a simple pruning algorithm to remove all the solved (or “fixed”) digits from neighbours of the fixed cells and we repeated the pruning till the fixed and non-fixed values in the grid stopped changing (or the grid “settled”). Here’s an example of a grid before pruning:</p>
<p><small></p>
<pre class="plain low-line-height"><code>+-------------------------------------+-------------------------------------+-------------------------------------+
| [123456789] [123456789] [123456789] | [123456789] [123456789] [123456789] | [123456789] 1           [123456789] |
| 4           [123456789] [123456789] | [123456789] [123456789] [123456789] | [123456789] [123456789] [123456789] |
| [123456789] 2           [123456789] | [123456789] [123456789] [123456789] | [123456789] [123456789] [123456789] |
+-------------------------------------+-------------------------------------+-------------------------------------+
| [123456789] [123456789] [123456789] | [123456789] 5           [123456789] | 4           [123456789] 7           |
| [123456789] [123456789] 8           | [123456789] [123456789] [123456789] | 3           [123456789] [123456789] |
| [123456789] [123456789] 1           | [123456789] 9           [123456789] | [123456789] [123456789] [123456789] |
+-------------------------------------+-------------------------------------+-------------------------------------+
| 3           [123456789] [123456789] | 4           [123456789] [123456789] | 2           [123456789] [123456789] |
| [123456789] 5           [123456789] | 1           [123456789] [123456789] | [123456789] [123456789] [123456789] |
| [123456789] [123456789] [123456789] | 8           [123456789] 6           | [123456789] [123456789] [123456789] |
+-------------------------------------+-------------------------------------+-------------------------------------+</code></pre>
<p></small></p>
<p>And here’s the same grid when it settles after repeated pruning:</p>
<p><small></p>
<pre class="plain low-line-height"><code>+-------------------------------------+-------------------------------------+-------------------------------------+
| [    56789] [  3  6789] [  3 567 9] | [ 23 567 9] [ 234 6 8 ] [ 2345 789] | [    56789] 1           [ 23456 89] |
| 4           [1 3  6789] [  3 567 9] | [ 23 567 9] [123  6 8 ] [123 5 789] | [    56789] [ 23 56789] [ 23 56 89] |
| [1   56789] 2           [  3 567 9] | [  3 567 9] [1 34 6 8 ] [1 345 789] | [    56789] [  3456789] [  3456 89] |
+-------------------------------------+-------------------------------------+-------------------------------------+
| [ 2   6  9] [  3  6  9] [ 23  6  9] | [ 23  6   ] 5           [123    8 ] | 4           [ 2   6 89] 7           |
| [ 2  567 9] [   4 67 9] 8           | [ 2   67  ] [12 4 6   ] [12 4  7  ] | 3           [ 2  56  9] [12  56  9] |
| [ 2  567  ] [  34 67  ] 1           | [ 23  67  ] 9           [ 234  78 ] | [    56 8 ] [ 2  56 8 ] [ 2  56 8 ] |
+-------------------------------------+-------------------------------------+-------------------------------------+
| 3           [1    6 89] [     6  9] | 4           7           [    5   9] | 2           [    56 89] [1   56 89] |
| [ 2   6789] 5           [ 2 4 67 9] | 1           [ 23      ] [ 23     9] | [     6789] [  34 6789] [  34 6 89] |
| [12    7 9] [1  4  7 9] [ 2 4  7 9] | 8           [ 23      ] 6           | [1   5 7 9] [  345 7 9] [1 345   9] |
+-------------------------------------+-------------------------------------+-------------------------------------+</code></pre>
<p></small></p>
<p>We can see how the possibilities conflicting with the fixed values are removed. We also see how some non-fixed cells turn into fixed ones as all of their other possible values are eliminated.</p>
<p>This simple strategy followed directly from the constraints of Sudoku. But, are there more complex strategies which are implied indirectly?</p>
<h2 id="singles-twins-and-triplets">Singles, Twins and Triplets<a href="#singles-twins-and-triplets" class="ref-link"></a><a href="#top" class="top-link" title="Back to top"></a></h2>
<p>Let’s have a look at this sample row captured from a solution in progress:</p>
<p><small></p>
<pre class="plain low-line-height"><code>+-------------------------------------+-------------------------------------+-------------------------------------+
| 4           [ 2   6 89] 7           | 3           [ 2  56  9] [12  56  9] | [    56 8 ] [ 2  56 8 ] [ 2  56 8 ] |
+-------------------------------------+-------------------------------------+-------------------------------------+</code></pre>
<p></small></p>
<p>Notice how the sixth cell is the only column with “1” as a possibility in it. It is obvious that the sixth cell should be fixed to “1” as it can never be placed in any other cell in the row. Let’s call this the “Single” scenario (“Single” as in <a href="https://en.wikipedia.org/wiki/Single_child" target="_blank" rel="noopener">“Single child”</a>).</p>
<p>In our current solution, the sixth cell will not be fixed to “1” either till all other possibilities of the cell are pruned away or, till the cell is chosen as pivot in the <code>nextGrids</code> function and “1” is chosen as the value to fix. This may take very long and lead to a longer solution time. If we recognize the Single scenario and fix the cell to “1” right then, it will prune the search tree by a lot and make the solution much faster.</p>
    </section>
    <section class="source">
      <a href="https://github.com/abhin4v/abhin4v.github.io/commits/source/posts/fast-sudoku-solver-in-haskell-2.md" target="_blank" rel="noopener">Post history</a>
    </section>
</article>
<meta itemprop="url" content="https://abhinavsarkar.net/drafts/fast-sudoku-solver-in-haskell-2/">

<script src="../../js/code-styling.js" defer async></script>
<script src="https://platform.twitter.com/widgets.js" charset="utf-8" defer async></script>
<script>
  window.asn_ss = window.asn_ss || [];
  window.asn_ss.push("https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css");
  window.asn_ss.push("https://cdn.rawgit.com/noelboss/featherlight/1.7.9/release/featherlight.min.css");
  window.setTimeout(function() {
      if (window.twttr == undefined) {
        document.getElementsByClassName("twitter-button")[0].setAttribute("style", "display: none");
      }
    }, 3000);
</script>

        </main>

        <footer>
            <span style="float: left">© 2017-2018, Abhinav Sarkar</span>
            Generated by <a href="http://jaspervdj.be/hakyll" target="_blank" rel="noopener">Hakyll</a> |
            <a href="https://github.com/abhin4v/abhin4v.github.io" target="_blank" rel="noopener">Source</a>
        </footer>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/haskell.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.1.0/highlightjs-line-numbers.min.js"></script>
    <script src="https://cdn.rawgit.com/noelboss/featherlight/1.7.9/release/featherlight.min.js"></script>
    <script src="https://use.fontawesome.com/85d14c6c2b.js"></script>
    <script>
      document.documentElement.className = document.documentElement.className.replace("no-js","js");
      hljs.initHighlightingOnLoad();
      hljs.initLineNumbersOnLoad({
        singleLine: true
      });

      function loadStyleSheet(src) {
        if (document.createStyleSheet){
          document.createStyleSheet(src);
        } else {
          jQuery("head").append(jQuery("<link rel='stylesheet' href='"+src+"' type='text/css'>"));
        }
      }

      jQuery(document).ready(function() {
        window.asn_ss = window.asn_ss || [];
        for (var i = 0; i < window.asn_ss.length; i++) {
          loadStyleSheet(window.asn_ss[i]);
        }
        jQuery("a.img-link").attr("data-featherlight", "image");
      });
    </script>
    <style type="text/css" media="print">
      @page { size: portrait; }
    </style>
  </body>
</html>
